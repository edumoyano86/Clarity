/**
 * @file firestore.rules
 * @description Firestore Security Rules for a personal finance application.
 *
 * @version 1.2
 *
 * @philosophy
 * This ruleset enforces a strict user-ownership security model. All user-generated
 * content is private and can only be accessed by the user who created it. There are
 * no public or shared collections.
 *
 * @structure
 * All data is stored hierarchically under a top-level `users` collection. Each user's
 * data, including their profile, income, expenses, and other financial records, is
 * nested under their unique user ID (`/users/{userId}/...`). This structural segregation
 * makes security rules simple, performant, and highly secure.
 *
 * @decisions
 * - Strict Ownership: All rules are based on matching the authenticated user's UID
 *   (`request.auth.uid`) with the `userId` parameter in the document path.
 * - No Public Data: There are no globally readable collections. Listing documents
 *   is only permitted within a user's own data tree.
 * - Relational Integrity: On creation, documents must contain an ownership field (e.g., `id` or `userId`)
 *   that matches the user ID in the path. This field is enforced as immutable upon update
 *   to prevent documents from being re-assigned to different users.
 * - Prototyping Flexibility: These rules do not validate the specific shape or data types
 *   of documents beyond what is required for authorization, allowing for rapid front-end
 *   development and iteration.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's ID matches the provided userId.
     * This is the foundation of the ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete
     * operations to prevent acting on non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the UserProfile document being created has an 'id' field
     * that matches the user's auth UID.
     */
    function isNewProfileDataValid(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates that a subcollection document being created has a 'userId' field
     * that correctly links it back to the owner specified in the path, if the field exists.
     */
    function isNewSubcollectionDataValid(userId) {
      return !('userId' in request.resource.data) || request.resource.data.userId == userId;
    }


    /**
     * Ensures the core ownership links ('id' for UserProfile, 'userId' for subcollections)
     * cannot be changed after a document is created.
     */
    function isOwnershipImmutable() {
      // For UserProfile, the field is 'id'. For all others, it might be 'userId'.
      if ('userId' in request.resource.data && 'userId' in resource.data) {
        return request.resource.data.userId == resource.data.userId;
      }
      if ('id' in request.resource.data && 'id' in resource.data) {
         return request.resource.data.id == resource.data.id;
      }
      return true; // If fields don't exist on both, we can't compare, so we allow.
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own profile document for the first time.
     * @deny (list) Any user attempting to list all user profiles in the application.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Deny listing all users for security
      allow create: if isOwner(userId) && isNewProfileDataValid(userId);
      allow update: if isExistingOwner(userId) && isOwnershipImmutable();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Controls access to all user-specific subcollections with a generic rule.
       * This applies to incomes, expenses, investments, notes, transactions, accounts, etc.
       * @path /users/{userId}/{collectionId}/{docId}
       * @allow The owner of the data tree can perform any action on their own documents.
       * @deny Any user trying to access data that doesn't belong to them.
       */
      match /{collectionId}/{docId} {
        allow read, write: if isOwner(userId);
      }
    }
  }
}
