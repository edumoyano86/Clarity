
/**
 * @file firestore.rules
 * @description Firestore Security Rules for a personal finance application.
 *
 * @version 1.5
 *
 * @philosophy
 * This ruleset enforces a strict user-ownership security model. All user-generated
 * content is private and can only be accessed by the user who created it. There are
 * no public or shared collections.
 *
 * @structure
 * All data is stored hierarchically under a top-level `users` collection. Each user's
 * data, including their profile, income, expenses, and other financial records, is
 * nested under their unique user ID (`/users/{userId}/...`). This structural segregation
 * makes security rules simple, performant, and highly secure.
 *
 * @decisions
 * - Strict Ownership: All rules are based on matching the authenticated user's UID
 *   (`request.auth.uid`) with the `userId` parameter in the document path.
 * - No Public Data: There are no globally readable collections. Listing documents
 *   is only permitted within a user's own data tree.
 * - Relational Integrity: On creation, documents should have an ownership field if applicable.
 *   This field is enforced as immutable upon update to prevent documents from being
 *   re-assigned to different users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's ID matches the provided userId.
     * This is the foundation of the ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Validates that the UserProfile document being created has an 'id' field
     * that matches the user's auth UID.
     */
    function isNewProfileDataValid(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Ensures the core ownership links ('id' for UserProfile, 'userId' for subcollections)
     * cannot be changed after a document is created.
     */
    function isOwnershipImmutable() {
      // For UserProfile, the field is 'id'. For all others, it might be 'userId'.
      if ('userId' in request.resource.data && 'userId' in resource.data) {
        return request.resource.data.userId == resource.data.userId;
      }
      if ('id' in request.resource.data && 'id' in resource.data) {
         return request.resource.data.id == resource.data.id;
      }
      return true; // If fields don't exist on both, we can't compare, so we allow.
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document and all their subcollections.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // Allow the owner to read and create their own profile.
      allow get: if isOwner(userId);
      allow create: if isOwner(userId) && isNewProfileDataValid(userId);
      // Allow updates only if ownership is not being changed.
      allow update: if isOwner(userId) && isOwnershipImmutable();
      allow delete: if isOwner(userId);
      // Deny listing all user profiles for security reasons.
      allow list: if false;

      /**
       * @description Generic rule to control access to all user-specific subcollections.
       * This applies to transactions, expenseCategories, accounts, investments, etc.
       * @path /users/{userId}/{collectionId}/{docId}
       * @allow The owner of the data tree can perform any action on their own documents.
       */
      match /{collectionId}/{docId} {
        allow read, write: if isOwner(userId);
      }
    }
  }
}
