/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all
 * data is partitioned by user ID. The design ensures that a user can only ever
 * access their own documents, providing strong data privacy and isolation by default.
 *
 * Data Structure: The data is organized hierarchically. A top-level `/users`
 * collection stores user profiles. All other user-specific data, such as
 * incomes, expenses, and expense categories, are stored in subcollections
 * directly under that user's document (e.g., /users/{userId}/incomes/{incomeId}).
 *
 * Key Security Decisions:
 * - User Isolation: All rules are based on path-based ownership. A user's
 *   authentication UID must match the `{userId}` wildcard in the path to gain access.
 * - No User Listing: Listing the entire `/users` collection is explicitly
 *   disallowed to protect user privacy and prevent enumeration attacks.
 * - Ownership Integrity: Rules enforce that when a document is created (e.g., an
 *   income), its internal `userId` field must match the user ID in the path,
 *   ensuring relational data is always consistent with its location.
 * - Immutability of Ownership: Key relational fields (like `id` on a user
 *   document or `userId` on a subcollection document) cannot be changed after
 *   creation, preventing documents from being "re-assigned" to another user.
 * - Default Deny: Access is denied by default; rules only grant permissions
 *   explicitly.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId from the path.
     * This is the foundation of the user-ownership model.
     * @param userId The user ID from the document path.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Checks if a document currently exists in Firestore.
     * Crucial for protecting against writes on non-existent documents.
     */
    function isExistingDoc() {
      return resource != null;
    }
    
    /**
     * A composite check for update/delete operations, ensuring the user is the
     * owner AND the document they are trying to modify already exists.
     * @param userId The user ID from the document path.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }
    
    /**
     * Validates that a new user document has an 'id' field matching its path.
     * Enforces relational integrity on creation.
     * @param userId The user ID from the document path.
     */
    function isCreatingValidUserDoc(userId) {
      return request.resource.data.id == userId;
    }
    
    /**
     * Validates that the 'id' field of a user document cannot be changed.
     * Enforces immutability of the primary user identifier.
     */
    function isUpdatingImmutableUserDoc() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that a new document in a user subcollection has a 'userId'
     * field matching its parent path. Enforces relational integrity.
     * @param userId The user ID from the parent document path.
     */
    function isCreatingValidSubDoc(userId) {
      return request.resource.data.userId == userId;
    }
    
    /**
     * Validates that the 'userId' field of a subcollection document cannot be changed.
     * Enforces immutability of the ownership link.
     */
    function isUpdatingImmutableSubDoc() {
      return request.resource.data.userId == resource.data.userId;
    }

    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow (create): A new user with auth.uid 'user123' creates their own profile at /users/user123.
     * @deny (list): Any user attempting to list all documents in the /users collection.
     * @principle Restricts access to a user's own data tree and allows self-creation of a profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isCreatingValidUserDoc(userId);
      allow update: if isExistingOwner(userId) && isUpdatingImmutableUserDoc();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages a user's income entries.
       * @path /users/{userId}/incomes/{incomeId}
       * @allow (get): A user with auth.uid 'user123' reads their own income document at /users/user123/incomes/inc456.
       * @deny (update): User 'userABC' tries to update an income document at /users/userXYZ/incomes/inc789.
       * @principle Enforces document ownership for all operations within a user-specific subcollection.
       */
      match /incomes/{incomeId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && isCreatingValidSubDoc(userId);
        allow update: if isExistingOwner(userId) && isUpdatingImmutableSubDoc();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages a user's expense entries.
       * @path /users/{userId}/expenses/{expenseId}
       * @allow (list): A user with auth.uid 'user123' lists all their expenses under /users/user123/expenses.
       * @deny (create): An unauthenticated user tries to create an expense document.
       * @principle Enforces document ownership for all operations within a user-specific subcollection.
       */
      match /expenses/{expenseId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && isCreatingValidSubDoc(userId);
        allow update: if isExistingOwner(userId) && isUpdatingImmutableSubDoc();
        allow delete: if isExistingOwner(userId);
      }
      
      /**
       * @description Manages a user's transactions.
       * @path /users/{userId}/transactions/{transactionId}
       * @allow (list): A user with auth.uid 'user123' lists all their transactions under /users/user123/transactions.
       * @deny (create): An unauthenticated user tries to create an transaction document.
       * @principle Enforces document ownership for all operations within a user-specific subcollection.
       */
      match /transactions/{transactionId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages a user's custom expense categories.
       * @path /users/{userId}/expenseCategories/{categoryId}
       * @allow (delete): A user with auth.uid 'user123' deletes their own category at /users/user123/expenseCategories/cat456.
       * @deny (get): User 'userABC' tries to read a category document at /users/userXYZ/expenseCategories/cat789.
       * @principle Enforces document ownership and validates relational integrity between documents.
       */
      match /expenseCategories/{categoryId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }
      
      /**
       * @description Manages a user's investments.
       * @path /users/{userId}/investments/{investmentId}
       * @allow (list): A user with auth.uid 'user123' lists all their investments under /users/user123/investments.
       * @deny (create): An unauthenticated user tries to create an investment document.
       * @principle Enforces document ownership for all operations within a user-specific subcollection.
       */
      match /investments/{investmentId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }
       /**
       * @description Manages a user's appointments.
       * @path /users/{userId}/appointments/{appointmentId}
       * @allow (list): A user with auth.uid 'user123' lists all their appointments under /users/user123/appointments.
       * @deny (create): An unauthenticated user tries to create an appointment document.
       * @principle Enforces document ownership for all operations within a user-specific subcollection.
       */
      match /appointments/{appointmentId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && isCreatingValidSubDoc(userId);
        allow update: if isExistingOwner(userId) && isUpdatingImmutableSubDoc();
        allow delete: if isExistingOwner(userId);
      }
      
      /**
       * @description Manages a user's payable accounts.
       * @path /users/{userId}/accounts/{accountId}
       * @allow (list): A user with auth.uid 'user123' lists all their accounts under /users/user123/accounts.
       * @deny (create): An unauthenticated user tries to create an account document.
       * @principle Enforces document ownership for all operations within a user-specific subcollection.
       */
      match /accounts/{accountId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages a user's notes.
       * @path /users/{userId}/notes/{noteId}
       * @allow (list): A user with auth.uid 'user123' lists all their notes under /users/user123/notes.
       * @deny (create): An unauthenticated user tries to create a note document.
       * @principle Enforces document ownership for all operations within a user-specific subcollection.
       */
      match /notes/{noteId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }
    }
  }
}

    