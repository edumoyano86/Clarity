
/**
 * @file firestore.rules
 * @description Firestore Security Rules for a personal finance application.
 *
 * @version 2.0
 *
 * @philosophy
 * This ruleset enforces a strict user-ownership security model. All user-generated
 * content is private and can only be accessed by the user who created it. There are
 * no public or shared collections.
 *
 * @structure
 * All data is stored hierarchically under a top-level `users` collection. Each user's
 * data, including their profile and all subcollections, is nested under their unique
 * user ID (`/users/{userId}/...`). This structural segregation makes security rules
 * simple, performant, and highly secure.
 *
 * @decisions
 * - Strict Ownership: All rules are based on matching the authenticated user's UID
 *   (`request.auth.uid`) with the `userId` parameter in the document path.
 * - No Public Data: There are no globally readable collections.
 * - Consolidated Rules: A single recursive wildcard match (`/{path=**}`) is used
 *   to apply ownership rules to all documents and subcollections under a user's
 *   directory, simplifying logic and preventing conflicting rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document and all their subcollections.
     * This single block secures all user data.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // READ: Allow owner to read their own profile.
      allow get: if isOwner(userId);
      
      // WRITE (CREATE): Allow owner to create their own profile.
      allow create: if isOwner(userId);

      // WRITE (UPDATE, DELETE): Allow owner to update or delete their own profile.
      allow update, delete: if isOwner(userId);
      
      // LIST: Deny listing all user profiles for security.
      allow list: if false;

      /**
       * @description Generic rule to control access to ALL user-specific subcollections recursively.
       * This includes listing documents in a collection and reading/writing individual documents.
       * @path /users/{userId}/{path=**}
       */
      match /{path=**} {
        allow read, write: if isOwner(userId);
      }
    }
  }
}
